name: TrixieOS ISO Build

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y \
          wget tar xz-utils \
          grub-pc-bin grub-common \
          xorriso mtools

    - name: Download Alpine minirootfs
      run: |
        wget https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/x86_64/alpine-minirootfs.tar.gz

    - name: Prepare rootfs
      run: |
        mkdir -p rootfs
        tar -xzf alpine-minirootfs.tar.gz -C rootfs

        cat <<EOF > rootfs/etc/os-release
NAME="TrixieOS"
ID=trixieos
VERSION="1.0"
PRETTY_NAME="TrixieOS 1.0"
EOF

        echo "trixieos" > rootfs/etc/hostname

        echo "Welcome to TrixieOS - ProjectA tarafından yapıldı" > rootfs/etc/motd

    - name: Download kernel & initrd
      run: |
        mkdir -p iso/boot
        wget https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/x86_64/netboot/vmlinuz-lts -O iso/boot/vmlinuz
        wget https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/x86_64/netboot/initramfs-lts -O iso/boot/initrd

    - name: Create GRUB config
      run: |
        mkdir -p iso/boot/grub

        cat <<EOF > iso/boot/grub/grub.cfg
set timeout=5
set default=0

menuentry "TrixieOS (ProjectA tarafından yapıldı)" {
    linux /boot/vmlinuz quiet
    initrd /boot/initrd
}
EOF

    - name: Build ISO
      run: |
        grub-mkrescue -o TrixieOS.iso iso

    - name: Upload ISO
      uses: actions/upload-artifact@v4
      with:
        name: TrixieOS-ISO
        path: TrixieOS.iso
